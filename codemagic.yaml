# Codemagic CI/CD Configuration for Bro App
# Docs: https://docs.codemagic.io/yaml-quick-start/building-a-flutter-app/

workflows:
  # ============================================
  # BUILD COMPLETO - Android + iOS
  # ============================================
  full-release:
    name: ðŸš€ Android + iOS (Testers)
    max_build_duration: 120
    instance_type: mac_mini_m2
    
    integrations:
      app_store_connect: Bro App
      
    environment:
      groups:
        - bro_secrets
      android_signing:
        - bro_keystore
      ios_signing:
        distribution_type: app_store
        bundle_identifier: app.brostr
      flutter: stable
      xcode: latest
      cocoapods: default
      java: 17
      
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'release/*'
          include: true
        - pattern: 'main'
          include: true
        - pattern: 'master'
          include: true
      
    scripts:
      - name: Generate env.json from CI variables
        script: |
          cat > "$CM_BUILD_DIR/env.json" <<EOF
          {
            "BREEZ_API_KEY": "$BREEZ_API_KEY",
            "PLATFORM_LIGHTNING_ADDRESS": "$PLATFORM_LIGHTNING_ADDRESS",
            "BACKEND_URL": "$BACKEND_URL"
          }
          EOF

      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Build APK Release (Android)
        script: flutter build apk --release --dart-define-from-file=env.json
        
      - name: Install CocoaPods
        script: |
          cd ios
          pod install
          
      - name: Build iOS
        script: |
          xcode-project use-profiles
          flutter build ipa --release --dart-define-from-file=env.json --export-options-plist=/Users/builder/export_options.plist
        
    artifacts:
      - build/**/outputs/**/*.apk
      - build/ios/ipa/*.ipa
      
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        submit_to_app_store: false  # Desabilitado atÃ© adicionar screenshots
        # Enviar automaticamente para testadores externos (link pÃºblico)
        # NOTA: Crie o grupo "Beta PÃºblico" no App Store Connect primeiro!
        # beta_groups:
        #   - Beta PÃºblico
      email:
        recipients:
          - your-email@example.com  # TODO: configure
        notify:
          success: true
          failure: true

  # ============================================
  # DISTRIBUIÃ‡ÃƒO PARA TESTERS (SEM LOJA)
  # Gera APK release assinado para Android
  # MANUAL - Use apenas se precisar sÃ³ do APK
  # ============================================
  testers-build:
    name: ðŸ“± Android APK (Manual)
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - bro_secrets
      android_signing:
        - bro_keystore
      flutter: stable
      java: 17
      
    scripts:
      - name: Generate env.json from CI variables
        script: |
          cat > "$CM_BUILD_DIR/env.json" <<EOF
          {
            "BREEZ_API_KEY": "$BREEZ_API_KEY",
            "PLATFORM_LIGHTNING_ADDRESS": "$PLATFORM_LIGHTNING_ADDRESS",
            "BACKEND_URL": "$BACKEND_URL"
          }
          EOF

      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Build APK Release (para distribuir)
        script: flutter build apk --release --dart-define-from-file=env.json
        
    artifacts:
      - build/**/outputs/**/*.apk
      
    publishing:
      email:
        recipients:
          - your-email@example.com  # TODO: configure
        notify:
          success: true
          failure: true

  # ============================================
  # ANDROID - Google Play Store
  # MANUAL - Requer credenciais do Google Play configuradas
  # ============================================
  android-release:
    name: ðŸ¤– Android Play Store (Manual)
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - google_play_credentials
        - keystore_credentials
        - bro_secrets
      flutter: stable
      java: 17
      
    scripts:
      - name: Set up keystore
        script: |
          echo $CM_KEYSTORE | base64 --decode > $CM_BUILD_DIR/android/app/bro-release.jks
          cat > "$CM_BUILD_DIR/android/key.properties" <<EOF
          storePassword=$CM_KEYSTORE_PASSWORD
          keyPassword=$CM_KEY_PASSWORD
          keyAlias=$CM_KEY_ALIAS
          storeFile=bro-release.jks
          EOF
          
      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Generate env.json from CI variables
        script: |
          cat > "$CM_BUILD_DIR/env.json" <<EOF
          {
            "BREEZ_API_KEY": "$BREEZ_API_KEY",
            "PLATFORM_LIGHTNING_ADDRESS": "$PLATFORM_LIGHTNING_ADDRESS",
            "BACKEND_URL": "$BACKEND_URL"
          }
          EOF

      - name: Build APK Release
        script: flutter build apk --release --dart-define-from-file=env.json
        
      - name: Build AAB (release for Play Store)
        script: flutter build appbundle --release --dart-define-from-file=env.json
        
    artifacts:
      - build/**/outputs/**/*.apk
      - build/**/outputs/**/*.aab
      - build/**/outputs/**/mapping.txt
      
    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true

  # ============================================
  # iOS - TestFlight / App Store
  # MANUAL - Use full-release para builds automÃ¡ticos
  # ============================================
  ios-release:
    name: ðŸŽ iOS TestFlight (Manual)
    max_build_duration: 90
    instance_type: mac_mini_m2
    
    integrations:
      app_store_connect: Bro App
      
    environment:
      groups:
        - app_store_credentials
        - bro_secrets
      ios_signing:
        distribution_type: app_store
        bundle_identifier: app.brostr
      flutter: stable
      xcode: latest
      cocoapods: default
          
    scripts:
      - name: Set up code signing
        script: xcode-project use-profiles
        
      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Install CocoaPods
        script: |
          cd ios
          pod install
          
      - name: Generate env.json from CI variables
        script: |
          cat > "$CM_BUILD_DIR/env.json" <<EOF
          {
            "BREEZ_API_KEY": "$BREEZ_API_KEY",
            "PLATFORM_LIGHTNING_ADDRESS": "$PLATFORM_LIGHTNING_ADDRESS",
            "BACKEND_URL": "$BACKEND_URL"
          }
          EOF

      - name: Build iOS
        script: flutter build ipa --release --dart-define-from-file=env.json --export-options-plist=/Users/builder/export_options.plist
        
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        submit_to_app_store: true

  # ============================================
  # DEBUG BUILD (para desenvolvimento)
  # ============================================
  debug-build:
    name: ðŸ”§ Debug Build
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - bro_secrets
      flutter: stable
      xcode: latest
      java: 17
      
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'develop'
          include: true
        - pattern: 'feature/*'
          include: true
          
    scripts:
      - name: Generate env.json from CI variables
        script: |
          cat > "$CM_BUILD_DIR/env.json" <<EOF
          {
            "BREEZ_API_KEY": "$BREEZ_API_KEY",
            "PLATFORM_LIGHTNING_ADDRESS": "$PLATFORM_LIGHTNING_ADDRESS",
            "BACKEND_URL": "$BACKEND_URL"
          }
          EOF

      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Analyze code
        script: flutter analyze --no-fatal-infos
        
      - name: Build Android Debug
        script: flutter build apk --debug --dart-define-from-file=env.json
        
    artifacts:
      - build/**/outputs/**/*.apk
